---
- name: Deploy application to Kubernetes using kubectl
  hosts: appserver
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/home/ec2-user/.kube/config"
    k8s_namespace: "ansiblek8s"
    deployment_file: "/home/ec2-user/k8s_deployment.yaml"
    eks_cluster_name: "mycluster"

  tasks:

    - name: Ensure .kube directory exists
      file:
        path: /home/ec2-user/.kube
        state: directory
        owner: ec2-user
        mode: '0700'

    # ðŸ”¹ ADD THIS TASK HERE
    - name: Generate kubeconfig for EKS
      command: >
        aws eks update-kubeconfig
        --region us-east-1
        --name {{ eks_cluster_name }}
        --kubeconfig {{ kubeconfig_path }}
      environment:
        AWS_DEFAULT_REGION: us-east-1
      become_user: ec2-user

    - name: Copy Kubernetes deployment manifest
      copy:
        src: ansible/k8s_deployment.yaml
        dest: "{{ deployment_file }}"
        owner: ec2-user
        mode: '0644'

    - name: Apply Kubernetes Deployment
      command: kubectl apply -f {{ deployment_file }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      become_user: ec2-user

    - name: Wait for deployment rollout
      command: kubectl rollout status deployment/k8s -n {{ k8s_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      become_user: ec2-user

