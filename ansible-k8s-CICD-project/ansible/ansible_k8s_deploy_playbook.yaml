---
- name: Deploy application to Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig_path: "~/.kube/config"
    namespace: "default"
    deployment_file: "ansible/k8s_deployment.yaml"

  tasks:

    - name: Ensure Kubernetes namespace exists
      community.kubernetes.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        state: present

    - name: Apply Kubernetes Deployment
      community.kubernetes.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition: "{{ lookup('file', deployment_file) | from_yaml }}"

    - name: Verify Deployment rollout status
      community.kubernetes.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
        name: k8s
        kubeconfig: "{{ kubeconfig_path }}"
      register: deployment_info

    - name: Wait for deployment to be ready
      community.kubernetes.k8s_wait:
        kubeconfig: "{{ kubeconfig_path }}"
        kind: Deployment
        namespace: "{{ namespace }}"
        name: k8s
        timeout: 300
        condition: available

    - name: Output deployed image version
      debug:
        msg: "Deployment is using image: {{ deployment_info.resources[0].spec.template.spec.containers[0].image }}"
