---
- name: Deploy application to Kubernetes using kubectl
  hosts: appserver
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/home/ec2-user/.kube/config"
    k8s_namespace: "default"
    deployment_file: "/home/ec2-user/k8s_deployment.yaml"

  tasks:

    - name: Ensure .kube directory exists
      file:
        path: /home/ec2-user/.kube
        state: directory
        owner: ec2-user
        mode: '0700'

    - name: Generate kubeconfig for EKS
      command: >
        aws eks update-kubeconfig
        --region us-east-1
        --name mycluster
        --kubeconfig {{ kubeconfig_path }}
      environment:
        AWS_DEFAULT_REGION: us-east-1
      become_user: ec2-user

    - name: Copy Kubernetes deployment manifest
      copy:
        src: ansible/k8s_deployment.yaml
        dest: "{{ deployment_file }}"
        owner: ec2-user
        mode: '0644'

    - name: Ensure Kubernetes namespace exists
      community.kubernetes.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ k8s_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        state: present

    - name: Apply Kubernetes Deployment
      community.kubernetes.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        src: "{{ deployment_file }}"

    - name: Wait for deployment to be ready
      community.kubernetes.k8s_wait:
        kubeconfig: "{{ kubeconfig_path }}"
        kind: Deployment
        namespace: "{{ k8s_namespace }}"
        name: k8s
        timeout: 300
        condition: available
