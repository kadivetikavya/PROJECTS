---
- name: Deploy application to Kubernetes using kubectl
  hosts: appserver
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/home/ec2-user/.kube/config"
    namespace: "default"
    deployment_file: "/home/ec2-user/k8s_deployment.yaml"

  tasks:

    - name: Ensure .kube directory exists
      file:
        path: /home/ec2-user/.kube
        state: directory
        owner: ec2-user
        mode: '0700'

    - name: Copy kubeconfig to app server
      copy:
        src: kubeconfig
        dest: "{{ kubeconfig_path }}"
        owner: ec2-user
        mode: '0600'

    - name: Copy Kubernetes deployment manifest
      copy:
        src: ansible/k8s_deployment.yaml
        dest: "{{ deployment_file }}"
        owner: ec2-user
        mode: '0644'

    - name: Ensure namespace exists
      command: kubectl get namespace {{ namespace }} --kubeconfig {{ kubeconfig_path }}
      register: ns_check
      failed_when: false
      changed_when: false

    - name: Create namespace if missing
      command: kubectl create namespace {{ namespace }} --kubeconfig {{ kubeconfig_path }}
      when: ns_check.rc != 0

    - name: Apply Kubernetes deployment
      command: kubectl apply -f {{ deployment_file }} --namespace {{ namespace }} --kubeconfig {{ kubeconfig_path }}

    - name: Wait for deployment rollout to complete
      command: kubectl rollout status deployment/k8s --namespace {{ namespace }} --timeout=300s --kubeconfig {{ kubeconfig_path }}

    - name: Get deployed image version
      command: >
        kubectl get deployment k8s
        --namespace {{ namespace }}
        --kubeconfig {{ kubeconfig_path }}
        -o jsonpath='{.spec.template.spec.containers[0].image}'
      register: image_version

    - name: Output deployed image version
      debug:
        msg: "Deployment is using image: {{ image_version.stdout }}"
